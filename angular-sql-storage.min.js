!function(e){"use strict";e.module("sf.sqlStorage",["LocalStorageModule"]),e.module("sf.sqlStorage").provider("sqlStorageMigrationService",function(){e.$inject=["$q","$injector"];var t={};function e(a,r){var i={};return i._database=null,i._updateMethods=t,i.updateManager=function(e,n){i._database=e;var t=Object.keys(i._updateMethods).sort().reduce(function(e,t){var a;return t=parseFloat(t),n<t&&e.push((a=t,r.invoke(i._updateMethods[a],i))),e},[]);return a.all(t)},i}this.addUpdater=function(e){t[e.version]=e.method},this.$get=e}),t.$inject=["sqlStorageMigrationServiceProvider"];var b="database_version";function t(t){e.$inject=["$q","$window","$log","$injector","localStorageService","sqlStorageMigrationService"];var u="database.db",l=1,d=null,f=null;function e(r,e,i,t,s,o){var a={},n=null;function c(e){var t=[e.name,e.type];return e.unique&&t.push("UNIQUE"),e.primayKey&&t.push("PRIMARY KEY"),t.join(" ")}return d||(i.error("Please set a database configuration"),d={}),a.createPromise=null,a.tables=d.tables||{},a.initDatabase=function(){return n=f?t.invoke(f):e.openDatabase(u,"1.0","database",2e5)},a.getDatabase=function(){return n||this.initDatabase()},a.initTables=function(){var n=this,e=this.tables;if(this.createPromise)return this.createPromise;return this.createPromise=this.createTables(d.defaultFields,e).then(function(){var e=n.getDatabase(),t=s.get(b)||0;return i.debug("[Storage] Create DB SUCCESS"),t&&t<l?o.updateManager(e,t).then(a):a();function a(){return s.set(b,l),e}}),this.createPromise},a.deleteDatas=function(){var a=this,e=Object.keys(this.tables).map(function(e){return a.tables[e].table_name}).map(function(e){var t="DROP TABLE IF EXISTS "+e;return a.execute(t)});return s.clearAll(),r.all(e).then(function(e){return a.createPromise=null,i.debug("[Storage] Drop DB SUCCESS"),e})},a.createTables=function(e,s){var o=this,u=(e||[]).map(c),t=Object.keys(s).map(function(e){var t,a,n,r,i=(t=s[e],a=u,n=t.indexed_fields||[],r=a.concat(n.map(c)),["CREATE TABLE IF NOT EXISTS",t.table_name,"("+r.join(", ")+")"].join(" "));return o.execute(i)});return r.all(t)},a.execute=function(t,a){var n=r.defer();return this.getDatabase().transaction(function(e){e.executeSql(t,a,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})}),n.promise},a}this.$get=e,this.setDatabaseConfig=function(e){u=e.name,l=e.version},this.setDatabaseSchema=function(e){d=e},this.setDatabaseInstance=function(e){f=e},this.addUpdater=function(e){t.addUpdater(e)}}e.module("sf.sqlStorage").provider("sqlStorageService",t)}(window.angular);