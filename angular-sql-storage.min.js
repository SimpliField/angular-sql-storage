!function(e){"use strict";e.module("sf.sqlStorage",["LocalStorageModule"]),e.module("sf.sqlStorage").provider("sqlStorageMigrationService",function(){e.$inject=["$q","$injector","localStorageService"];var a={};function e(t,n,r){var i={};return i._database=null,i._updateMethods=a,i.updateManager=function(e,a){i._database=e;return Object.keys(i._updateMethods).map(parseFloat).sort(function(e,t){return e-t}).reduce(function(e,t){return a<t&&e.push(t),e},[]).reduce(function(e,t){return e.then(function(){return(e=t,n.invoke(i._updateMethods[e],i)).then(function(){return r.set("database_version",t)});var e})},t.when())},i}this.addUpdater=function(e){a[e.version]=e.method},this.$get=e}),t.$inject=["sqlStorageMigrationServiceProvider"];var h="database_version";function t(t){e.$inject=["$q","$window","$log","$injector","localStorageService","sqlStorageMigrationService"];var u="database.db",l=1,d=null,f=null;function e(r,e,n,t,i,o){var a={},s=null;function c(e){var t=[e.name,e.type];return e.unique&&t.push("UNIQUE"),e.primayKey&&t.push("PRIMARY KEY"),t.join(" ")}return d||(n.error("Please set a database configuration"),d={}),a.createPromise=null,a.tables=d.tables||{},a.initDatabase=function(){return s=f?t.invoke(f):e.openDatabase(u,"1.0","database",2e5)},a.getDatabase=function(){return s||this.initDatabase()},a.initTables=function(){var a=this,e=this.tables;if(this.createPromise)return this.createPromise;return this.createPromise=this.createTables(d.defaultFields,e).then(function(){var t=a.getDatabase(),e=i.get(h)||0;return n.debug("[Storage] Create DB SUCCESS"),e&&e<l?o.updateManager(t,e).then(function(){return t}).catch(function(e){return n.error(e),t}):function(){return i.set(h,l),t}()}),this.createPromise},a.deleteDatas=function(){var a=this,e=Object.keys(this.tables).map(function(e){return a.tables[e].table_name}).map(function(e){var t="DROP TABLE IF EXISTS "+e;return a.execute(t)});return i.clearAll(),r.all(e).then(function(e){return a.createPromise=null,n.debug("[Storage] Drop DB SUCCESS"),e})},a.createTables=function(e,o){var s=this,u=(e||[]).map(c),t=Object.keys(o).map(function(e){var t,a,n,r,i=(t=o[e],a=u,n=t.indexed_fields||[],r=a.concat(n.map(c)),["CREATE TABLE IF NOT EXISTS",t.table_name,"("+r.join(", ")+")"].join(" "));return s.execute(i)});return r.all(t)},a.execute=function(t,a){var n=r.defer();return this.getDatabase().transaction(function(e){e.executeSql(t,a,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})}),n.promise},a}this.$get=e,this.setDatabaseConfig=function(e){u=e.name,l=e.version},this.setDatabaseSchema=function(e){d=e},this.setDatabaseInstance=function(e){f=e},this.addUpdater=function(e){t.addUpdater(e)}}e.module("sf.sqlStorage").provider("sqlStorageService",t)}(window.angular);